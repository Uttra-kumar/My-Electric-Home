<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Fees Payment System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-blue: #2c3e50;
            --secondary-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-yellow: #f1c40f;
            --accent-purple: #9b59b6;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
            --text-light: #ffffff;
            --text-dark: #2c3e50;
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-bg));
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, var(--accent-green), var(--secondary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--text-light);
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            color: var(--primary-blue);
        }
        
        .section-header i {
            font-size: 1.3rem;
            color: var(--secondary-blue);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark-bg);
            font-size: 0.95rem;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-blue), #2980b9);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #27ae60);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--accent-yellow), #f39c12);
            color: var(--text-dark);
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(241, 196, 15, 0.3);
        }
        
        .btn-print {
            background: linear-gradient(135deg, var(--accent-purple), #8e44ad);
            color: white;
        }
        
        .btn-print:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-top: 4px solid;
        }
        
        .summary-card h3 {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .total-fees { border-color: var(--primary-blue); }
        .paid-amount { border-color: var(--accent-green); }
        .remaining { border-color: var(--accent-red); }
        .installments { border-color: var(--accent-purple); }
        
        .total-fees .value { color: var(--primary-blue); }
        .paid-amount .value { color: var(--accent-green); }
        .remaining .value { color: var(--accent-red); }
        .installments .value { color: var(--accent-purple); }
        
        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-green), #27ae60);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        /* Search Section */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--secondary-blue);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .student-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
        }
        
        .student-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
            position: relative;
        }
        
        .student-item:hover {
            background: #f8f9fa;
        }
        
        .student-item.selected {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--secondary-blue);
        }
        
        .student-item.payment-complete {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid var(--accent-green);
        }
        
        .student-item.payment-incomplete {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid var(--accent-red);
        }
        
        .student-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-blue);
            margin-bottom: 5px;
        }
        
        .student-details {
            font-size: 0.85rem;
            color: #7f8c8d;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .payment-status {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .payment-status.complete {
            background: rgba(46, 204, 113, 0.2);
            color: var(--accent-green);
        }
        
        .payment-status.incomplete {
            background: rgba(231, 76, 60, 0.2);
            color: var(--accent-red);
        }
        
        /* Payment Cards */
        .payment-history {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .payment-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--accent-green);
        }
        
        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .payment-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .payment-date {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .payment-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.9rem;
        }
        
        @media (max-width: 480px) {
            .payment-details {
                grid-template-columns: 1fr;
            }
        }
        
        .payment-detail strong {
            color: var(--primary-blue);
        }
        
        .payment-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .modal-header h3 {
            font-size: 1.4rem;
            color: var(--primary-blue);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #7f8c8d;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            background: #f8f9fa;
        }
        
        /* Print Options */
        .print-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .print-options {
                grid-template-columns: 1fr;
            }
        }
        
        .print-option {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .print-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .print-option.selected {
            border-color: var(--secondary-blue);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .print-option i {
            font-size: 2rem;
            color: var(--secondary-blue);
            margin-bottom: 10px;
        }
        
        .print-option h4 {
            font-size: 1.1rem;
            color: var(--primary-blue);
            margin-bottom: 5px;
        }
        
        .print-option p {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--accent-green), #27ae60);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--accent-red), #c0392b);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, var(--accent-yellow), #f39c12);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-university"></i> Student Fees Payment System</h1>
            <p>Manage student fees, track installments, and print receipts</p>
        </div>
        
        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Student Registration -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-user-plus"></i>
                        <h2>Student Registration</h2>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Student Name *</label>
                            <input type="text" id="studentName" class="form-input" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Roll Number *</label>
                            <input type="text" id="rollNumber" class="form-input" placeholder="Enter roll number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Course *</label>
                            <input type="text" id="course" class="form-input" placeholder="e.g., B.Tech CSE">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <input type="tel" id="mobile" class="form-input" placeholder="Enter mobile number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="email" class="form-input" placeholder="Enter email address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Fees (₹) *</label>
                            <input type="number" id="totalFees" class="form-input" placeholder="Enter total fees">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="address" class="form-input" placeholder="Enter address" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="registerStudent()">
                            <i class="fas fa-save"></i> Register Student
                        </button>
                        <button class="btn btn-warning" onclick="clearForm()" style="margin-left: 10px;">
                            <i class="fas fa-redo"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Search Student -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-search"></i>
                        <h2>Search Student</h2>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by name or roll number..." oninput="searchStudents()">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div class="student-list" id="studentList">
                        <!-- Students will appear here -->
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="right-column">
                <!-- Student Summary -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-chart-bar"></i>
                        <h2 id="selectedStudentName">Select a Student</h2>
                    </div>
                    
                    <div class="summary-cards">
                        <div class="summary-card total-fees">
                            <h3>Total Fees</h3>
                            <div class="value" id="summaryTotalFees">₹0</div>
                        </div>
                        <div class="summary-card paid-amount">
                            <h3>Paid Amount</h3>
                            <div class="value" id="summaryPaid">₹0</div>
                        </div>
                        <div class="summary-card remaining">
                            <h3>Remaining</h3>
                            <div class="value" id="summaryRemaining">₹0</div>
                        </div>
                        <div class="summary-card installments">
                            <h3>Installments</h3>
                            <div class="value" id="summaryInstallments">0</div>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Payment Progress</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn btn-print" onclick="openPrintModal()" id="printBtn" disabled>
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                        <button class="btn btn-success" onclick="addPayment()" id="addPaymentBtn" disabled>
                            <i class="fas fa-plus-circle"></i> Add Payment
                        </button>
                        <button class="btn btn-warning" onclick="viewAllReceipts()" id="viewAllBtn" disabled>
                            <i class="fas fa-list"></i> View All
                        </button>
                    </div>
                </div>
                
                <!-- Add Payment -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-money-bill-wave"></i>
                        <h2>Add Payment</h2>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Amount (₹) *</label>
                            <input type="number" id="paymentAmount" class="form-input" placeholder="Enter amount">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Date</label>
                            <input type="date" id="paymentDate" class="form-input" value="">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Payment Mode</label>
                            <select id="paymentMode" class="form-input">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="UPI">UPI</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transaction ID</label>
                            <input type="text" id="transactionId" class="form-input" placeholder="Optional">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="paymentNotes" class="form-input" placeholder="Add notes" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Payment History -->
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-history"></i>
                        <h2>Recent Payments</h2>
                    </div>
                    
                    <div class="payment-history" id="paymentHistory">
                        <!-- Payments will appear here -->
                        <div style="text-align: center; color: #7f8c8d; padding: 30px;">
                            Select a student to view payment history
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Print Modal -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Print Receipt Options</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="print-options">
                <div class="print-option selected" onclick="selectPrintOption('receipt')">
                    <i class="fas fa-receipt"></i>
                    <h4>Single Receipt</h4>
                    <p>Print individual payment receipt</p>
                </div>
                
                <div class="print-option" onclick="selectPrintOption('statement')">
                    <i class="fas fa-file-alt"></i>
                    <h4>Fee Statement</h4>
                    <p>Complete fee statement with table</p>
                </div>
                
                <div class="print-option" onclick="selectPrintOption('barcode')">
                    <i class="fas fa-barcode"></i>
                    <h4>Barcode Receipt</h4>
                    <p>Receipt with scannable barcode</p>
                </div>
            </div>
            
            <!-- Print Preview -->
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-primary" onclick="generatePrintPreview()">
                    <i class="fas fa-eye"></i> Generate Preview
                </button>
            </div>
            
            <div id="printPreview" style="margin: 20px 0; display: none;">
                <!-- Preview will be shown here -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="printReceipt()" id="printNowBtn" disabled>
                    <i class="fas fa-print"></i> Print Now
                </button>
                <button class="btn btn-success" style="flex: 1;" onclick="downloadPDF()" id="downloadPdfBtn" disabled>
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button class="btn btn-warning" style="flex: 1;" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- All Receipts Modal -->
    <div class="modal" id="allReceiptsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>All Payments - <span id="modalStudentName"></span></h3>
                <button class="close-modal" onclick="closeAllReceiptsModal()">&times;</button>
            </div>
            
            <div id="allReceiptsContainer" style="max-height: 500px; overflow-y: auto;">
                <!-- All receipts will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://iydamvrlxtwsnqvflaxq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZGFtdnJseHR3c25xdmZsYXhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTczMTIsImV4cCI6MjA3MzY3MzMxMn0.Z8m6XGyu9wsN_UJ8EZYr12BRemsO12_U8EEZ9JizQ6w';
        let supabase;
        
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.warn('Supabase not configured, using local storage only');
            showNotification('Running in offline mode. Data will be saved locally.', 'warning');
        }
        
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Global variables
        let selectedStudent = null;
        let students = [];
        let payments = [];
        let selectedPrintOption = 'receipt';
        let printPreviewGenerated = false;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();
            // Set today's date
            document.getElementById('paymentDate').valueAsDate = new Date();
        });
        
        // Register a new student
        async function registerStudent() {
            const studentName = document.getElementById('studentName').value.trim();
            const rollNumber = document.getElementById('rollNumber').value.trim();
            const course = document.getElementById('course').value.trim();
            const mobile = document.getElementById('mobile').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();
            const totalFees = parseFloat(document.getElementById('totalFees').value);
            
            if (!studentName || !rollNumber || !course || !totalFees) {
                showNotification('Please fill all required fields (*)', 'error');
                return;
            }
            
            if (isNaN(totalFees) || totalFees <= 0) {
                showNotification('Please enter valid total fees', 'error');
                return;
            }
            
            const studentData = {
                student_name: studentName,
                roll_number: rollNumber,
                course: course,
                mobile: mobile || null,
                email: email || null,
                address: address || null,
                total_fees: totalFees,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('students')
                        .insert([studentData])
                        .select();
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        students.push(data[0]);
                    }
                } else {
                    studentData.id = Date.now();
                    let localStudents = JSON.parse(localStorage.getItem('students') || '[]');
                    localStudents.push(studentData);
                    localStorage.setItem('students', JSON.stringify(localStudents));
                    students.push(studentData);
                }
                
                showNotification('Student registered successfully!', 'success');
                clearForm();
                loadStudents();
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error registering student', 'error');
            }
        }
        
        // Load all students
        async function loadStudents() {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('students')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (!error && data) {
                        students = data;
                    }
                } else {
                    const localStudents = JSON.parse(localStorage.getItem('students') || '[]');
                    students = localStudents;
                }
                
                displayStudents(students);
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }
        
        // Display students with color coding for payment status
        async function displayStudents(studentList) {
            const studentListElement = document.getElementById('studentList');
            
            if (studentList.length === 0) {
                studentListElement.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 30px;">No students found</div>';
                return;
            }
            
            // Create HTML for each student with payment status
            let studentsHTML = '';
            
            for (const student of studentList) {
                let paymentStatus = 'incomplete';
                let statusText = 'Incomplete';
                let statusClass = 'payment-incomplete';
                
                // Get payments for this student
                let studentPayments = [];
                if (supabase) {
                    const { data, error } = await supabase
                        .from('payments')
                        .select('amount')
                        .eq('student_id', student.id);
                    
                    if (!error && data) {
                        studentPayments = data;
                    }
                } else {
                    const allPayments = JSON.parse(localStorage.getItem('payments') || '[]');
                    studentPayments = allPayments.filter(p => p.student_id === student.id);
                }
                
                const totalPaid = studentPayments.reduce((sum, p) => sum + p.amount, 0);
                
                if (totalPaid >= student.total_fees) {
                    paymentStatus = 'complete';
                    statusText = 'Paid';
                    statusClass = 'payment-complete';
                } else if (totalPaid > 0) {
                    statusText = 'Partial';
                }
                
                const isSelected = selectedStudent && selectedStudent.id === student.id;
                
                studentsHTML += `
                    <div class="student-item ${isSelected ? 'selected' : ''} ${statusClass}" 
                         onclick="selectStudent(${student.id})">
                        <div class="student-name">${student.student_name}</div>
                        <div class="student-details">
                            <span>Roll: ${student.roll_number}</span>
                            <span>Course: ${student.course}</span>
                            <span>Fees: ₹${student.total_fees}</span>
                            ${student.mobile ? `<span>Mobile: ${student.mobile}</span>` : ''}
                        </div>
                        <div class="payment-status ${paymentStatus}">${statusText}</div>
                    </div>
                `;
            }
            
            studentListElement.innerHTML = studentsHTML;
        }
        
        // Search students
        function searchStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayStudents(students);
                return;
            }
            
            const filteredStudents = students.filter(student =>
                student.student_name.toLowerCase().includes(searchTerm) ||
                student.roll_number.toLowerCase().includes(searchTerm) ||
                student.course.toLowerCase().includes(searchTerm) ||
                (student.mobile && student.mobile.toLowerCase().includes(searchTerm)) ||
                (student.email && student.email.toLowerCase().includes(searchTerm))
            );
            
            displayStudents(filteredStudents);
        }
        
        // Select a student
        async function selectStudent(studentId) {
            selectedStudent = students.find(s => s.id === studentId);
            
            if (!selectedStudent) return;
            
            document.getElementById('selectedStudentName').textContent = selectedStudent.student_name;
            document.getElementById('modalStudentName').textContent = selectedStudent.student_name;
            document.getElementById('printBtn').disabled = false;
            document.getElementById('addPaymentBtn').disabled = false;
            document.getElementById('viewAllBtn').disabled = false;
            
            await loadPayments();
            updateSummary();
            displayStudents(students); // Refresh student list to update selection
            
            showNotification(`Selected: ${selectedStudent.student_name}`, 'success');
        }
        
        // Load payments for selected student
        async function loadPayments() {
            if (!selectedStudent) return;
            
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('payments')
                        .select('*')
                        .eq('student_id', selectedStudent.id)
                        .order('payment_date', { ascending: false });
                    
                    if (!error && data) {
                        payments = data;
                    }
                } else {
                    const allPayments = JSON.parse(localStorage.getItem('payments') || '[]');
                    payments = allPayments.filter(p => p.student_id === selectedStudent.id)
                        .sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date));
                }
                
                displayPayments();
                
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }
        
        // Display payments
        function displayPayments() {
            const paymentHistoryElement = document.getElementById('paymentHistory');
            
            if (payments.length === 0) {
                paymentHistoryElement.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 30px;">No payments found</div>';
                return;
            }
            
            paymentHistoryElement.innerHTML = payments.map(payment => {
                const paymentDate = new Date(payment.payment_date);
                const formattedDate = paymentDate.toLocaleDateString('en-IN');
                
                return `
                    <div class="payment-card">
                        <div class="payment-header">
                            <div class="payment-amount">₹${payment.amount}</div>
                            <div class="payment-date">${formattedDate}</div>
                        </div>
                        <div class="payment-details">
                            <div class="payment-detail"><strong>Mode:</strong> ${payment.payment_mode}</div>
                            <div class="payment-detail"><strong>Transaction ID:</strong> ${payment.transaction_id || 'N/A'}</div>
                            <div class="payment-detail"><strong>Notes:</strong> ${payment.notes || 'None'}</div>
                            <div class="payment-detail"><strong>Status:</strong> Paid</div>
                        </div>
                        <div class="payment-actions">
                            <button class="btn btn-primary" onclick="printSingleReceipt(${payment.id})">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Add payment
        async function addPayment() {
            if (!selectedStudent) {
                showNotification('Please select a student first', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const transactionId = document.getElementById('transactionId').value.trim();
            const notes = document.getElementById('paymentNotes').value.trim();
            
            if (!amount || amount <= 0) {
                showNotification('Please enter valid amount', 'error');
                return;
            }
            
            if (!paymentDate) {
                showNotification('Please select payment date', 'error');
                return;
            }
            
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = selectedStudent.total_fees - totalPaid;
            
            if (amount > remaining) {
                showNotification(`Amount exceeds remaining fees (₹${remaining})`, 'error');
                return;
            }
            
            const paymentData = {
                student_id: selectedStudent.id,
                student_name: selectedStudent.student_name,
                roll_number: selectedStudent.roll_number,
                amount: amount,
                payment_date: paymentDate,
                payment_mode: paymentMode,
                transaction_id: transactionId || null,
                notes: notes || null,
                status: 'Paid',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('payments')
                        .insert([paymentData])
                        .select();
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        payments.unshift(data[0]);
                    }
                } else {
                    paymentData.id = Date.now();
                    let allPayments = JSON.parse(localStorage.getItem('payments') || '[]');
                    allPayments.push(paymentData);
                    localStorage.setItem('payments', JSON.stringify(allPayments));
                    payments.unshift(paymentData);
                }
                
                document.getElementById('paymentAmount').value = '';
                document.getElementById('transactionId').value = '';
                document.getElementById('paymentNotes').value = '';
                
                displayPayments();
                updateSummary();
                displayStudents(students); // Refresh student list to update status
                
                showNotification(`Payment of ₹${amount} added successfully!`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error adding payment', 'error');
            }
        }
        
        // Update summary
        function updateSummary() {
            if (!selectedStudent) return;
            
            const totalFees = selectedStudent.total_fees;
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = totalFees - totalPaid;
            const progressPercentage = totalFees > 0 ? Math.round((totalPaid / totalFees) * 100) : 0;
            
            document.getElementById('summaryTotalFees').textContent = `₹${totalFees}`;
            document.getElementById('summaryPaid').textContent = `₹${totalPaid}`;
            document.getElementById('summaryRemaining').textContent = `₹${remaining}`;
            document.getElementById('summaryInstallments').textContent = payments.length;
            
            document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            
            // Change progress bar color based on completion
            const progressFill = document.getElementById('progressFill');
            if (progressPercentage >= 100) {
                progressFill.style.background = 'linear-gradient(to right, #2ecc71, #27ae60)';
            } else if (progressPercentage >= 50) {
                progressFill.style.background = 'linear-gradient(to right, #f1c40f, #f39c12)';
            } else {
                progressFill.style.background = 'linear-gradient(to right, #e74c3c, #c0392b)';
            }
        }
        
        // Open print modal
        function openPrintModal() {
            if (!selectedStudent || payments.length === 0) {
                showNotification('No payments to print', 'error');
                return;
            }
            
            document.getElementById('printModal').classList.add('show');
            printPreviewGenerated = false;
            document.getElementById('printPreview').style.display = 'none';
            document.getElementById('printNowBtn').disabled = true;
            document.getElementById('downloadPdfBtn').disabled = true;
        }
        
        // Select print option
        function selectPrintOption(option) {
            selectedPrintOption = option;
            
            document.querySelectorAll('.print-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            printPreviewGenerated = false;
            document.getElementById('printPreview').style.display = 'none';
            document.getElementById('printNowBtn').disabled = true;
            document.getElementById('downloadPdfBtn').disabled = true;
        }
        
        // Generate print preview
        function generatePrintPreview() {
            const previewElement = document.getElementById('printPreview');
            
            let previewHTML = '';
            
            switch (selectedPrintOption) {
                case 'receipt':
                    previewHTML = generateReceiptHTML();
                    break;
                case 'statement':
                    previewHTML = generateStatementHTML();
                    break;
                case 'barcode':
                    previewHTML = generateBarcodeHTML();
                    break;
            }
            
            previewElement.innerHTML = previewHTML;
            previewElement.style.display = 'block';
            printPreviewGenerated = true;
            document.getElementById('printNowBtn').disabled = false;
            document.getElementById('downloadPdfBtn').disabled = false;
            
            if (selectedPrintOption === 'barcode') {
                setTimeout(() => {
                    generateBarcodeSVG();
                }, 100);
            }
        }
        
        // Generate receipt HTML
        function generateReceiptHTML() {
            const payment = payments[0];
            const paymentDate = new Date(payment.payment_date);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = selectedStudent.total_fees - totalPaid;
            const paymentStatus = remaining <= 0 ? 'FULLY PAID' : 'PARTIAL PAYMENT';
            const statusColor = remaining <= 0 ? '#27ae60' : '#f39c12';
            
            return `
                <div style="font-family: Arial, sans-serif; padding: 20px; border: 2px solid #ddd; border-radius: 10px; background: white;">
                    <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                        <h1 style="margin: 0; color: #2c3e50; font-size: 28px;">FEE PAYMENT RECEIPT</h1>
                        <p style="color: #7f8c8d; margin: 5px 0; font-size: 16px;">Official Payment Acknowledgement</p>
                        <div style="background: ${statusColor}; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: bold;">
                            ${paymentStatus}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px;">STUDENT INFORMATION</h3>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0; width: 40%;"><strong>Name:</strong></td><td>${selectedStudent.student_name}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Roll No:</strong></td><td>${selectedStudent.roll_number}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Course:</strong></td><td>${selectedStudent.course}</td></tr>
                                ${selectedStudent.mobile ? `<tr><td style="padding: 8px 0;"><strong>Mobile:</strong></td><td>${selectedStudent.mobile}</td></tr>` : ''}
                                ${selectedStudent.email ? `<tr><td style="padding: 8px 0;"><strong>Email:</strong></td><td>${selectedStudent.email}</td></tr>` : ''}
                                <tr><td style="padding: 8px 0;"><strong>Date:</strong></td><td>${paymentDate.toLocaleDateString('en-IN')}</td></tr>
                            </table>
                        </div>
                        
                        <div>
                            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px;">PAYMENT DETAILS</h3>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0; width: 40%;"><strong>Receipt No:</strong></td><td>REC-${payment.id}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Amount:</strong></td><td style="font-weight: bold; color: #27ae60;">₹${payment.amount}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Mode:</strong></td><td>${payment.payment_mode}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Transaction ID:</strong></td><td>${payment.transaction_id || 'N/A'}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Status:</strong></td><td style="color: #27ae60; font-weight: bold;">PAID</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                        <div style="color: #7f8c8d; font-size: 18px; margin-bottom: 10px;">FEE SUMMARY</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 14px;">
                            <div><strong>Total Fees:</strong><br>₹${selectedStudent.total_fees}</div>
                            <div><strong>Total Paid:</strong><br>₹${totalPaid}</div>
                            <div><strong>Remaining:</strong><br>₹${remaining}</div>
                            <div><strong>Installments:</strong><br>${payments.length}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                        <div>
                            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px;">NOTES</h3>
                            <p style="font-size: 14px;">${payment.notes || 'No additional notes'}</p>
                        </div>
                        
                        <div>
                            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px;">SIGNATURE</h3>
                            <div style="height: 100px; display: flex; flex-direction: column; justify-content: flex-end;">
                                <div style="border-top: 2px solid #000; width: 250px; margin: 40px auto 10px;"></div>
                                <div style="text-align: center; font-size: 14px;">Authorized Signatory</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; color: #7f8c8d; font-size: 12px;">
                        <p>This is a computer generated receipt. No signature required.</p>
                        <p>Receipt ID: ${payment.id} | Generated on: ${new Date().toLocaleString('en-IN')}</p>
                    </div>
                </div>
            `;
        }
        
        // Generate statement HTML
        function generateStatementHTML() {
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = selectedStudent.total_fees - totalPaid;
            const paymentStatus = remaining <= 0 ? 'FULLY PAID' : 'PARTIAL PAYMENT';
            const statusColor = remaining <= 0 ? '#27ae60' : '#f39c12';
            
            let paymentRows = '';
            payments.forEach((payment, index) => {
                const paymentDate = new Date(payment.payment_date);
                paymentRows += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">${paymentDate.toLocaleDateString('en-IN')}</td>
                        <td style="border: 1px solid #ddd; padding: 10px; text-align: right;">₹${payment.amount}</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">${payment.payment_mode}</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">${payment.transaction_id || 'N/A'}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="font-family: Arial, sans-serif; padding: 20px; border: 2px solid #ddd; border-radius: 10px; background: white;">
                    <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                        <h1 style="margin: 0; color: #2c3e50; font-size: 28px;">FEE PAYMENT STATEMENT</h1>
                        <p style="color: #7f8c8d; margin: 5px 0; font-size: 16px;">Complete Fee Payment History</p>
                        <div style="background: ${statusColor}; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: bold;">
                            ${paymentStatus}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px;">STUDENT INFORMATION</h3>
                        <table style="width: 100%; font-size: 14px; margin: 15px 0;">
                            <tr>
                                <td style="padding: 8px 0; width: 30%;"><strong>Student Name:</strong><br>${selectedStudent.student_name}</td>
                                <td style="padding: 8px 0; width: 25%;"><strong>Roll Number:</strong><br>${selectedStudent.roll_number}</td>
                                <td style="padding: 8px 0; width: 25%;"><strong>Course:</strong><br>${selectedStudent.course}</td>
                                <td style="padding: 8px 0; width: 20%;"><strong>Total Fees:</strong><br>₹${selectedStudent.total_fees}</td>
                            </tr>
                            ${selectedStudent.mobile || selectedStudent.email ? `
                            <tr>
                                ${selectedStudent.mobile ? `<td style="padding: 8px 0;"><strong>Mobile:</strong><br>${selectedStudent.mobile}</td>` : '<td></td>'}
                                ${selectedStudent.email ? `<td style="padding: 8px 0;"><strong>Email:</strong><br>${selectedStudent.email}</td>` : '<td></td>'}
                                <td style="padding: 8px 0;"><strong>Address:</strong><br>${selectedStudent.address || 'N/A'}</td>
                                <td style="padding: 8px 0;"><strong>Statement Date:</strong><br>${new Date().toLocaleDateString('en-IN')}</td>
                            </tr>
                            ` : ''}
                        </table>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 25px 0;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-top: 4px solid #2c3e50;">
                            <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 10px;">Total Fees</div>
                            <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">₹${selectedStudent.total_fees}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-top: 4px solid #27ae60;">
                            <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 10px;">Total Paid</div>
                            <div style="font-size: 24px; font-weight: bold; color: #27ae60;">₹${totalPaid}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-top: 4px solid #e74c3c;">
                            <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 10px;">Remaining</div>
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">₹${remaining}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-top: 4px solid #9b59b6;">
                            <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 10px;">Installments</div>
                            <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${payments.length}</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px; margin-top: 30px;">PAYMENT HISTORY</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 14px;">
                        <thead>
                            <tr style="background: #2c3e50; color: white;">
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: center; width: 10%;">#</th>
                                <th style="border: 1px solid #ddd; padding: 12px; width: 20%;">Date</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right; width: 20%;">Amount</th>
                                <th style="border: 1px solid #ddd; padding: 12px; width: 25%;">Payment Mode</th>
                                <th style="border: 1px solid #ddd; padding: 12px; width: 25%;">Transaction ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paymentRows}
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td colspan="2" style="border: 1px solid #ddd; padding: 12px;">TOTAL PAID</td>
                                <td style="border: 1px solid #ddd; padding: 12px; text-align: right;">₹${totalPaid}</td>
                                <td colspan="2" style="border: 1px solid #ddd; padding: 12px;"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                        <div style="text-align: center; width: 45%;">
                            <div style="border-top: 2px solid #000; width: 250px; margin: 40px auto 10px;"></div>
                            <div style="font-size: 14px;">Student Signature</div>
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <div style="border-top: 2px solid #000; width: 250px; margin: 40px auto 10px;"></div>
                            <div style="font-size: 14px;">Accountant Signature</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; color: #7f8c8d; font-size: 12px;">
                        <p>This is a computer generated statement. No signature required.</p>
                        <p>Statement ID: STMT-${selectedStudent.id}-${Date.now()} | Generated on: ${new Date().toLocaleString('en-IN')}</p>
                    </div>
                </div>
            `;
        }
        
        // Generate barcode HTML
        function generateBarcodeHTML() {
            const payment = payments[0];
            const barcodeData = `STU${selectedStudent.id}PAY${payment.id}`;
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = selectedStudent.total_fees - totalPaid;
            const paymentStatus = remaining <= 0 ? 'FULLY PAID' : 'PARTIAL PAYMENT';
            const statusColor = remaining <= 0 ? '#27ae60' : '#f39c12';
            
            return `
                <div style="font-family: Arial, sans-serif; padding: 20px; border: 2px solid #ddd; border-radius: 10px; background: white; text-align: center;">
                    <div style="border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                        <h1 style="margin: 0; color: #2c3e50; font-size: 28px;">FEE PAYMENT RECEIPT</h1>
                        <p style="color: #7f8c8d; margin: 5px 0; font-size: 16px;">With Scannable Barcode</p>
                        <div style="background: ${statusColor}; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: bold;">
                            ${paymentStatus}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0; text-align: left;">
                        <div>
                            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px;">STUDENT INFO</h3>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0; width: 40%;"><strong>Name:</strong></td><td>${selectedStudent.student_name}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Roll No:</strong></td><td>${selectedStudent.roll_number}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Course:</strong></td><td>${selectedStudent.course}</td></tr>
                                ${selectedStudent.mobile ? `<tr><td style="padding: 8px 0;"><strong>Mobile:</strong></td><td>${selectedStudent.mobile}</td></tr>` : ''}
                            </table>
                        </div>
                        
                        <div>
                            <h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 5px; font-size: 18px;">PAYMENT INFO</h3>
                            <table style="width: 100%; font-size: 14px;">
                                <tr><td style="padding: 8px 0; width: 40%;"><strong>Receipt No:</strong></td><td>REC-${payment.id}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Date:</strong></td><td>${new Date(payment.payment_date).toLocaleDateString('en-IN')}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Mode:</strong></td><td>${payment.payment_mode}</td></tr>
                                <tr><td style="padding: 8px 0;"><strong>Amount:</strong></td><td style="font-weight: bold; color: #27ae60;">₹${payment.amount}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="background: #2c3e50; color: white; padding: 12px; border-radius: 5px; margin: 25px 0; font-size: 16px; font-weight: bold;">
                        SCAN BELOW BARCODE TO VERIFY PAYMENT
                    </div>
                    
                    <div style="border: 2px dashed #ddd; padding: 20px; border-radius: 10px; margin: 20px 0; background: white;">
                        <svg id="barcodeSvg" style="max-width: 100%; height: 80px;"></svg>
                        <div style="font-family: monospace; font-size: 16px; margin: 15px 0; letter-spacing: 2px; color: #2c3e50;">
                            ${barcodeData}
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 14px; text-align: left;">
                        <div><strong>Scan Instructions:</strong></div>
                        <div>1. Scan the barcode using any barcode scanner</div>
                        <div>2. The system will display student payment details</div>
                        <div>3. Use for verification and record keeping</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; color: #7f8c8d; font-size: 12px;">
                        <p>Barcode contains: StudentID-${selectedStudent.id} PaymentID-${payment.id}</p>
                        <p>Generated on: ${new Date().toLocaleString('en-IN')}</p>
                    </div>
                </div>
            `;
        }
        
        // Generate barcode SVG
        function generateBarcodeSVG() {
            const payment = payments[0];
            const barcodeData = `STU${selectedStudent.id}PAY${payment.id}`;
            
            try {
                JsBarcode("#barcodeSvg", barcodeData, {
                    format: "CODE128",
                    width: 2,
                    height: 60,
                    displayValue: true,
                    fontOptions: "bold",
                    textAlign: "center",
                    fontSize: 14,
                    background: "#ffffff",
                    lineColor: "#000000"
                });
            } catch (error) {
                console.error('Barcode error:', error);
            }
        }
        
        // Print receipt - FIXED VERSION
        function printReceipt() {
            if (!printPreviewGenerated) {
                showNotification('Please generate preview first', 'error');
                return;
            }
            
            const previewElement = document.getElementById('printPreview');
            const printContent = previewElement.innerHTML;
            
            // Create print window
            const printWindow = window.open('', '_blank', 'width=900,height=650');
            
            if (!printWindow) {
                showNotification('Please allow popups for printing', 'error');
                return;
            }
            
            const studentName = selectedStudent ? selectedStudent.student_name : 'Student';
            
            // Build HTML using string concatenation
            printWindow.document.write('<html><head><title>Print Receipt - ' + studentName + '</title>');
            printWindow.document.write('<meta charset="UTF-8">');
            printWindow.document.write('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
            printWindow.document.write('<style>');
            printWindow.document.write('@media print { @page { size: A4; margin: 10mm; } body { margin: 0; padding: 0; } .no-print { display: none !important; } }');
            printWindow.document.write('body { font-family: Arial, sans-serif; margin: 15px; padding: 0; background: white; }');
            printWindow.document.write('.print-btn { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; background: #2c3e50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; z-index: 1000; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div>' + printContent + '</div>');
            printWindow.document.write('<button class="print-btn no-print" onclick="window.print()">Print Now</button>');
            printWindow.document.write('<script>setTimeout(function() { window.print(); }, 1000);<\/script>');
            printWindow.document.write('</body></html>');
            
            printWindow.document.close();
            printWindow.focus();
        }
        
        // Download PDF
        async function downloadPDF() {
            if (!printPreviewGenerated) {
                showNotification('Please generate preview first', 'error');
                return;
            }
            
            try {
                const previewElement = document.getElementById('printPreview');
                
                const canvas = await html2canvas(previewElement, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                const imgWidth = pageWidth - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                const fileName = `Fee_Receipt_${selectedStudent.roll_number}_${Date.now()}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                
                // Simple fallback PDF
                const doc = new jsPDF();
                doc.setFontSize(16);
                doc.text('Fee Payment Receipt', 20, 20);
                doc.setFontSize(12);
                doc.text(`Student: ${selectedStudent.student_name}`, 20, 30);
                doc.text(`Roll No: ${selectedStudent.roll_number}`, 20, 40);
                doc.text(`Course: ${selectedStudent.course}`, 20, 50);
                doc.save(`Receipt_${selectedStudent.roll_number}_${Date.now()}.pdf`);
                showNotification('Simple PDF downloaded!', 'success');
            }
        }
        
        // Print single receipt - FIXED VERSION
        function printSingleReceipt(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const paymentDate = new Date(payment.payment_date);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = selectedStudent.total_fees - totalPaid;
            const paymentStatus = remaining <= 0 ? 'FULLY PAID' : 'PARTIAL PAYMENT';
            const statusColor = remaining <= 0 ? '#27ae60' : '#f39c12';
            
            // Create the print content as a string
            let printContent = '';
            printContent += '<div style="font-family: Arial, sans-serif; padding: 25px; max-width: 800px; margin: 0 auto;">';
            printContent += '<div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 30px;">';
            printContent += '<h1 style="margin: 0; color: #2c3e50; font-size: 28px;">FEE PAYMENT RECEIPT</h1>';
            printContent += '<p style="color: #7f8c8d; margin: 10px 0; font-size: 16px;">Official Payment Acknowledgement</p>';
            printContent += '<p style="margin: 5px 0; font-size: 14px;">Receipt No: REC-' + payment.id + '</p>';
            printContent += '<div style="background: ' + statusColor + '; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: bold;">' + paymentStatus + '</div>';
            printContent += '</div>';
            
            printContent += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px;">';
            printContent += '<div>';
            printContent += '<h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 8px; margin-bottom: 15px; font-size: 18px;">STUDENT INFORMATION</h3>';
            printContent += '<p><strong>Name:</strong> ' + selectedStudent.student_name + '</p>';
            printContent += '<p><strong>Roll No:</strong> ' + selectedStudent.roll_number + '</p>';
            printContent += '<p><strong>Course:</strong> ' + selectedStudent.course + '</p>';
            if (selectedStudent.mobile) {
                printContent += '<p><strong>Mobile:</strong> ' + selectedStudent.mobile + '</p>';
            }
            printContent += '<p><strong>Payment Date:</strong> ' + paymentDate.toLocaleDateString('en-IN') + '</p>';
            printContent += '</div>';
            
            printContent += '<div>';
            printContent += '<h3 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 8px; margin-bottom: 15px; font-size: 18px;">PAYMENT DETAILS</h3>';
            printContent += '<p><strong>Amount:</strong> <span style="font-weight: bold; color: #27ae60; font-size: 18px;">₹' + payment.amount + '</span></p>';
            printContent += '<p><strong>Mode:</strong> ' + payment.payment_mode + '</p>';
            printContent += '<p><strong>Transaction ID:</strong> ' + (payment.transaction_id || 'N/A') + '</p>';
            printContent += '<p><strong>Status:</strong> <span style="color: #27ae60; font-weight: bold;">PAID</span></p>';
            printContent += '</div>';
            printContent += '</div>';
            
            printContent += '<div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin: 30px 0; text-align: center;">';
            printContent += '<h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 20px;">FEE SUMMARY</h3>';
            printContent += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; font-size: 15px;">';
            printContent += '<div style="padding: 15px; background: white; border-radius: 8px; border-top: 4px solid #2c3e50;">';
            printContent += '<div style="font-size: 13px; color: #7f8c8d; margin-bottom: 8px;">Total Fees</div>';
            printContent += '<div style="font-size: 20px; font-weight: bold; color: #2c3e50;">₹' + selectedStudent.total_fees + '</div>';
            printContent += '</div>';
            printContent += '<div style="padding: 15px; background: white; border-radius: 8px; border-top: 4px solid #27ae60;">';
            printContent += '<div style="font-size: 13px; color: #7f8c8d; margin-bottom: 8px;">Total Paid</div>';
            printContent += '<div style="font-size: 20px; font-weight: bold; color: #27ae60;">₹' + totalPaid + '</div>';
            printContent += '</div>';
            printContent += '<div style="padding: 15px; background: white; border-radius: 8px; border-top: 4px solid #e74c3c;">';
            printContent += '<div style="font-size: 13px; color: #7f8c8d; margin-bottom: 8px;">Remaining</div>';
            printContent += '<div style="font-size: 20px; font-weight: bold; color: #e74c3c;">₹' + remaining + '</div>';
            printContent += '</div>';
            printContent += '<div style="padding: 15px; background: white; border-radius: 8px; border-top: 4px solid #9b59b6;">';
            printContent += '<div style="font-size: 13px; color: #7f8c8d; margin-bottom: 8px;">Installments</div>';
            printContent += '<div style="font-size: 20px; font-weight: bold; color: #9b59b6;">' + payments.length + '</div>';
            printContent += '</div>';
            printContent += '</div>';
            printContent += '</div>';
            
            printContent += '<div style="text-align: center; margin-top: 50px;">';
            printContent += '<div style="border-top: 2px solid #000; width: 250px; margin: 0 auto 10px; padding-top: 40px;"></div>';
            printContent += '<div style="font-size: 15px; font-weight: bold;">Authorized Signatory</div>';
            printContent += '</div>';
            
            printContent += '<div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #7f8c8d; font-size: 12px;">';
            printContent += '<p>This is a computer generated receipt. No signature required.</p>';
            printContent += '<p>Generated on: ' + new Date().toLocaleString('en-IN') + '</p>';
            printContent += '</div>';
            printContent += '</div>';
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            printWindow.document.write('<html><head><title>Print Receipt</title>');
            printWindow.document.write('<style>@media print { @page { size: A4; margin: 10mm; } body { margin: 0; padding: 0; } .no-print { display: none !important; } }</style>');
            printWindow.document.write('<style>body { font-family: Arial, sans-serif; margin: 15px; padding: 0; background: white; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('<button class="no-print" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #2c3e50; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="window.print()">Print Now</button>');
            printWindow.document.write('<script>setTimeout(function() { window.print(); }, 1000);<\/script>');
            printWindow.document.write('</body></html>');
            
            printWindow.document.close();
            printWindow.focus();
        }
        
        // View all receipts
        function viewAllReceipts() {
            if (!selectedStudent || payments.length === 0) {
                showNotification('No payments found', 'error');
                return;
            }
            
            const container = document.getElementById('allReceiptsContainer');
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = selectedStudent.total_fees - totalPaid;
            const paymentStatus = remaining <= 0 ? 'FULLY PAID' : 'PARTIAL PAYMENT';
            const statusColor = remaining <= 0 ? '#27ae60' : '#f39c12';
            
            let receiptsHTML = '<div style="text-align: center; margin-bottom: 20px;">';
            receiptsHTML += '<div style="background: ' + statusColor + '; color: white; padding: 10px 20px; border-radius: 20px; display: inline-block; font-weight: bold; font-size: 16px;">';
            receiptsHTML += 'Payment Status: ' + paymentStatus + ' | Total Paid: ₹' + totalPaid + ' | Remaining: ₹' + remaining;
            receiptsHTML += '</div></div>';
            
            receiptsHTML += payments.map(payment => {
                const paymentDate = new Date(payment.payment_date);
                
                return `
                    <div class="payment-card" style="margin-bottom: 15px;">
                        <div class="payment-header">
                            <div class="payment-amount">₹${payment.amount}</div>
                            <div class="payment-date">${paymentDate.toLocaleDateString('en-IN')}</div>
                        </div>
                        <div class="payment-details">
                            <div class="payment-detail"><strong>Mode:</strong> ${payment.payment_mode}</div>
                            <div class="payment-detail"><strong>Transaction ID:</strong> ${payment.transaction_id || 'N/A'}</div>
                            <div class="payment-detail"><strong>Receipt ID:</strong> ${payment.id}</div>
                            <div class="payment-detail"><strong>Status:</strong> Paid</div>
                        </div>
                        <div class="payment-actions">
                            <button class="btn btn-primary" onclick="printSingleReceipt(${payment.id})">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = receiptsHTML;
            
            document.getElementById('allReceiptsModal').classList.add('show');
        }
        
        // Close modals
        function closeModal() {
            document.getElementById('printModal').classList.remove('show');
        }
        
        function closeAllReceiptsModal() {
            document.getElementById('allReceiptsModal').classList.remove('show');
        }
        
        // Clear form
        function clearForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('rollNumber').value = '';
            document.getElementById('course').value = '';
            document.getElementById('mobile').value = '';
            document.getElementById('email').value = '';
            document.getElementById('address').value = '';
            document.getElementById('totalFees').value = '';
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>