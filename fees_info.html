<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Fees Details</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-blue: #2c3e50;
            --secondary-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-yellow: #f1c40f;
            --light-bg: #ecf0f1;
            --text-dark: #2c3e50;
            --card-bg: #ffffff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-blue), #1a252f);
            min-height: 100vh;
            padding: 15px;
            color: var(--text-dark);
            font-size: 13px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-bg);
        }
        
        .header-title h1 {
            font-size: 1.5rem;
            color: var(--primary-blue);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-title p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .back-btn {
            padding: 8px 16px;
            background: var(--secondary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        /* Student Info Section */
        .student-info-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-bg);
        }
        
        .student-header h2 {
            font-size: 1.2rem;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .student-details-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 1200px) {
            .student-details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .student-details-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .detail-group {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--secondary-blue);
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 1rem;
            color: var(--primary-blue);
            font-weight: 600;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 992px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #eee;
            border-top: 4px solid;
        }
        
        .summary-card h3 {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .total-fees { border-color: var(--primary-blue); }
        .paid-amount { border-color: var(--accent-green); }
        .remaining { border-color: var(--accent-red); }
        .installments { border-color: var(--accent-yellow); }
        
        .total-fees .value { color: var(--primary-blue); }
        .paid-amount .value { color: var(--accent-green); }
        .remaining .value { color: var(--accent-red); }
        .installments .value { color: var(--accent-yellow); }
        
        /* Progress Bar */
        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .progress-header h3 {
            font-size: 1.1rem;
            color: var(--primary-blue);
        }
        
        .progress-percentage {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--secondary-blue);
        }
        
        .progress-bar {
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-green), #27ae60);
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 600;
        }
        
        /* Filter Section */
        .filter-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filter-header h3 {
            font-size: 1.1rem;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-form {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        @media (max-width: 1200px) {
            .filter-form {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .filter-form {
                grid-template-columns: 1fr;
            }
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 6px;
        }
        
        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        /* Payment History Section */
        .payments-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        
        .payments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .payments-header h3 {
            font-size: 1.1rem;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-payment-btn {
            padding: 10px 18px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .add-payment-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }
        
        /* Payments Table */
        .payments-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .payments-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 900px;
        }
        
        .payments-table th {
            background: var(--primary-blue);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.9rem;
        }
        
        .payments-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .payments-table tr:hover {
            background: #f8f9fa;
        }
        
        /* Date cell styling - highlighted */
        .date-cell {
            background: #fff9e6;
            font-weight: 600;
            color: #d35400;
            border-radius: 4px;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-success {
            background: rgba(46, 204, 113, 0.15);
            color: var(--accent-green);
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }
        
        .btn-edit {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary-blue);
        }
        
        .btn-edit:hover {
            background: var(--secondary-blue);
            color: white;
        }
        
        .btn-delete {
            background: rgba(231, 76, 60, 0.1);
            color: var(--accent-red);
        }
        
        .btn-delete:hover {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-print {
            background: rgba(241, 196, 15, 0.1);
            color: var(--accent-yellow);
        }
        
        .btn-print:hover {
            background: var(--accent-yellow);
            color: white;
        }
        
        /* Payment Form Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-bg);
        }
        
        .modal-header h3 {
            font-size: 1.2rem;
            color: var(--primary-blue);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #7f8c8d;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            background: #f8f9fa;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .receipt-display {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin: 12px 0;
            border: 1px dashed #ddd;
        }
        
        .receipt-display .label {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        
        .receipt-display .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-blue);
            font-family: monospace;
            letter-spacing: 0.5px;
        }
        
        /* Button Styles */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--secondary-blue);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: var(--accent-green);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #27ae60;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: var(--accent-yellow);
            color: var(--text-dark);
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #f39c12;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Print Modal - Smaller */
        .print-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }
        
        .print-option {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .print-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .print-option.selected {
            border-color: var(--secondary-blue);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .print-option i {
            font-size: 1.5rem;
            color: var(--secondary-blue);
            margin-bottom: 8px;
        }
        
        .print-option h4 {
            font-size: 1rem;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }
        
        .print-option p {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        /* Print Preview */
        .print-preview {
            display: none;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .print-preview.show {
            display: block;
        }
        
        .preview-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .preview-controls .btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
        }
        
        .notification.success {
            background: var(--accent-green);
        }
        
        .notification.error {
            background: var(--accent-red);
        }
        
        .notification.warning {
            background: var(--accent-yellow);
            color: var(--text-dark);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* No Payments State */
        .no-payments {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .no-payments i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ddd;
            display: block;
        }
        
        /* Print Layout for 2 receipts per page */
        @media print {
            .receipt-print {
                width: 50% !important;
                float: left !important;
                page-break-inside: avoid !important;
                border: 1px solid #ddd !important;
                margin: 5mm !important;
                padding: 10px !important;
                box-sizing: border-box !important;
            }
            
            .receipt-print:nth-child(2n+1) {
                clear: left !important;
            }
            
            .page-break {
                page-break-after: always !important;
                clear: both !important;
            }
        }
        
        /* Scrollbar Styling */
        .payments-table-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .payments-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .payments-table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .payments-table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1><i class="fas fa-file-invoice-dollar"></i> Student Fees Details</h1>
                <p>View and manage student payment records</p>
            </div>
            <a href="temp.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Students
            </a>
        </div>
        
        <!-- Student Information -->
        <div class="student-info-section">
            <div class="student-header">
                <h2><i class="fas fa-user-graduate"></i> <span id="studentNameDisplay">Student Information</span></h2>
                <div style="color: #7f8c8d; font-size: 0.85rem;">
                    Roll No: <span id="studentRollDisplay" style="font-weight: bold;">-</span>
                </div>
            </div>
            
            <div class="student-details-grid">
                <div class="detail-group">
                    <div class="detail-label">Course</div>
                    <div class="detail-value" id="studentCourse">-</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Mobile</div>
                    <div class="detail-value" id="studentMobile">-</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Email</div>
                    <div class="detail-value" id="studentEmail">-</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Address</div>
                    <div class="detail-value" id="studentAddress">-</div>
                </div>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card total-fees">
                <h3>Total Fees</h3>
                <div class="value" id="summaryTotalFees">₹0</div>
            </div>
            <div class="summary-card paid-amount">
                <h3>Paid Amount</h3>
                <div class="value" id="summaryPaid">₹0</div>
            </div>
            <div class="summary-card remaining">
                <h3>Remaining</h3>
                <div class="value" id="summaryRemaining">₹0</div>
            </div>
            <div class="summary-card installments">
                <h3>Installments</h3>
                <div class="value" id="summaryInstallments">0</div>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h3>Payment Progress</h3>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-stats">
                <span>Paid: <span id="paidAmount">₹0</span></span>
                <span>Remaining: <span id="remainingAmount">₹0</span></span>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-header">
                <h3><i class="fas fa-filter"></i> Filter Payments</h3>
                <button class="btn btn-warning" onclick="clearFilters()">
                    <i class="fas fa-redo"></i> Clear
                </button>
            </div>
            
            <form class="filter-form" onsubmit="return false">
                <div class="filter-group">
                    <label class="filter-label">From Date</label>
                    <input type="date" id="filterFromDate" class="filter-input" onchange="filterPayments()">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">To Date</label>
                    <input type="date" id="filterToDate" class="filter-input" onchange="filterPayments()">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Amount Range</label>
                    <select id="filterAmountRange" class="filter-select" onchange="filterPayments()">
                        <option value="all">All Amounts</option>
                        <option value="0-1000">₹0 - ₹1,000</option>
                        <option value="1001-5000">₹1,001 - ₹5,000</option>
                        <option value="5001-10000">₹5,001 - ₹10,000</option>
                        <option value="10001-50000">₹10,001 - ₹50,000</option>
                        <option value="50001-100000">₹50,001 - ₹100,000</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Payment Mode</label>
                    <select id="filterPaymentMode" class="filter-select" onchange="filterPayments()">
                        <option value="all">All Modes</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="UPI">UPI</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
            </form>
        </div>
        
        <!-- Payment History -->
        <div class="payments-section">
            <div class="payments-header">
                <h3><i class="fas fa-history"></i> Payment History</h3>
                <button class="add-payment-btn" onclick="openPaymentModal()">
                    <i class="fas fa-plus-circle"></i> Add Payment
                </button>
            </div>
            
            <div class="payments-table-container">
                <table class="payments-table" id="paymentsTable">
                    <thead>
                        <tr>
                            <th style="width: 12%;">Receipt No</th>
                            <th style="width: 8%;">Date</th>
                            <th style="width: 10%;">Amount</th>
                            <th style="width: 15%;">Mode</th>
                            <th style="width: 18%;">Transaction ID</th>
                            <th style="width: 13%;">Notes</th>
                            <th style="width: 8%;">Status</th>
                            <th style="width: 16%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <!-- Payments will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Payment Form Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> Add Payment</h3>
                <button class="close-modal" onclick="closePaymentModal()">&times;</button>
            </div>
            
            <div class="receipt-display">
                <div class="label">Receipt Number</div>
                <div class="value" id="receiptNumberDisplay">Generating...</div>
            </div>
            
            <form id="paymentForm" onsubmit="return false">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Amount (₹) *</label>
                        <input type="number" id="paymentAmount" class="form-input" placeholder="Enter amount" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Date *</label>
                        <input type="date" id="paymentDate" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Payment Mode *</label>
                        <select id="paymentMode" class="form-select" required>
                            <option value="">Select Mode</option>
                            <option value="Cash">Cash</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="UPI">UPI</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Transaction ID</label>
                        <input type="text" id="transactionId" class="form-input" placeholder="Optional">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="paymentNotes" class="form-input" placeholder="Add notes" rows="2"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-warning" onclick="closePaymentModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success" style="flex: 2;" onclick="submitPayment()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Print Modal - Smaller -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-print"></i> Print Options</h3>
                <button class="close-modal" onclick="closePrintModal()">&times;</button>
            </div>
            
            <div class="print-options">
                <div class="print-option selected" onclick="selectPrintOption('receipt')" id="printReceiptOption">
                    <i class="fas fa-receipt"></i>
                    <h4>Single Receipt</h4>
                    <p>Print payment receipt</p>
                </div>
                
                <div class="print-option" onclick="selectPrintOption('statement')" id="printStatementOption">
                    <i class="fas fa-file-alt"></i>
                    <h4>Fee Statement</h4>
                    <p>Complete statement</p>
                </div>
            </div>
            
            <div class="print-preview" id="printPreview">
                <!-- Preview will be generated here -->
            </div>
            
            <div class="preview-controls">
                <button class="btn btn-primary" onclick="generatePreview()" id="previewBtn">
                    <i class="fas fa-eye"></i> Generate Preview
                </button>
                <button class="btn btn-success" onclick="printNow()" id="printNowBtn" disabled>
                    <i class="fas fa-print"></i> Print Now
                </button>
                <button class="btn btn-warning" onclick="downloadPDF()" id="downloadPdfBtn" disabled>
                    <i class="fas fa-download"></i> Download PDF
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://iydamvrlxtwsnqvflaxq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZGFtdnJseHR3c25xdmZsYXhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTczMTIsImV4cCI6MjA3MzY3MzMxMn0.Z8m6XGyu9wsN_UJ8EZYr12BRemsO12_U8EEZ9JizQ6w';
        let supabase;
        
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (error) {
            console.warn('Supabase not configured, using local storage only');
        }
        
        // Global variables
        let selectedStudent = null;
        let payments = [];
        let filteredPayments = [];
        let editingPaymentId = null;
        let selectedPrintOption = 'receipt';
        let selectedPaymentForPrint = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentFromStorage();
            loadPayments();
            generateReceiptNumber();
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            // Set filter date range to current month
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            document.getElementById('filterFromDate').valueAsDate = firstDay;
            document.getElementById('filterToDate').valueAsDate = lastDay;
        });
        
        // Load student from localStorage
        function loadStudentFromStorage() {
            const studentData = localStorage.getItem('selectedStudent');
            if (studentData) {
                selectedStudent = JSON.parse(studentData);
                displayStudentInfo();
            } else {
                showNotification('No student selected. Redirecting...', 'error');
                setTimeout(() => {
                    window.location.href = 'temp.html';
                }, 2000);
            }
        }
        
        // Display student information
        function displayStudentInfo() {
            if (!selectedStudent) return;
            
            document.getElementById('studentNameDisplay').textContent = selectedStudent.student_name;
            document.getElementById('studentRollDisplay').textContent = selectedStudent.roll_number;
            document.getElementById('studentCourse').textContent = selectedStudent.course || '-';
            document.getElementById('studentMobile').textContent = selectedStudent.mobile || '-';
            document.getElementById('studentEmail').textContent = selectedStudent.email || '-';
            document.getElementById('studentAddress').textContent = selectedStudent.address || '-';
        }
        
        // Load payments for selected student
        async function loadPayments() {
            if (!selectedStudent) return;
            
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('payments')
                        .select('*')
                        .eq('student_id', selectedStudent.id)
                        .order('payment_date', { ascending: false });
                    
                    if (!error && data) {
                        payments = data;
                        filteredPayments = [...data];
                    }
                } else {
                    const allPayments = JSON.parse(localStorage.getItem('payments') || '[]');
                    payments = allPayments.filter(p => p.student_id === selectedStudent.id)
                        .sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date));
                    filteredPayments = [...payments];
                }
                
                updateSummary();
                displayPayments();
                
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }
        
        // Display payments in table with highlighted dates
        function displayPayments() {
            const tableBody = document.getElementById('paymentsTableBody');
            
            if (filteredPayments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-payments">
                            <i class="fas fa-file-invoice"></i>
                            <div style="font-size: 1rem; margin-top: 10px;">No payments found</div>
                            <div style="font-size: 0.85rem; margin-top: 5px;">Add a payment to get started</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            
            filteredPayments.forEach((payment, index) => {
                const paymentDate = new Date(payment.payment_date);
                const formattedDate = paymentDate.toLocaleDateString('en-IN');
                const today = new Date();
                const isToday = paymentDate.toDateString() === today.toDateString();
                
                tableHTML += `
                    <tr>
                        <td><strong>${payment.receipt_number || 'N/A'}</strong></td>
                        <td class="${isToday ? 'date-cell' : ''}">
                            ${formattedDate}
                            ${isToday ? ' <span style="color:#27ae60;font-size:0.7rem;">(Today)</span>' : ''}
                        </td>
                        <td><strong style="color: #27ae60;">₹${payment.amount}</strong></td>
                         <td>${payment.payment_mode}</td>
                        <td>${payment.transaction_id || 'N/A'}</td>
                        <td>${payment.notes || 'N/A'}</td>
                        <td><span class="status-badge status-success">PAID</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn btn-edit" onclick="editPayment(${payment.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete" onclick="deletePayment(${payment.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="action-btn btn-print" onclick="openPrintModalForPayment(${payment.id})" title="Print">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }
        
        // Filter payments
        function filterPayments() {
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            const amountRange = document.getElementById('filterAmountRange').value;
            const paymentMode = document.getElementById('filterPaymentMode').value;
            
            filteredPayments = payments.filter(payment => {
                let match = true;
                
                // Filter by date range
                if (fromDate && toDate) {
                    const paymentDate = new Date(payment.payment_date);
                    const startDate = new Date(fromDate);
                    const endDate = new Date(toDate);
                    endDate.setHours(23, 59, 59, 999);
                    
                    if (paymentDate < startDate || paymentDate > endDate) {
                        match = false;
                    }
                }
                
                // Filter by amount range
                if (amountRange !== 'all') {
                    const amount = payment.amount;
                    
                    switch(amountRange) {
                        case '0-1000':
                            if (amount < 0 || amount > 1000) match = false;
                            break;
                        case '1001-5000':
                            if (amount < 1001 || amount > 5000) match = false;
                            break;
                        case '5001-10000':
                            if (amount < 5001 || amount > 10000) match = false;
                            break;
                        case '10001-50000':
                            if (amount < 10001 || amount > 50000) match = false;
                            break;
                        case '50001-100000':
                            if (amount < 50001 || amount > 100000) match = false;
                            break;
                    }
                }
                
                // Filter by payment mode
                if (paymentMode !== 'all' && payment.payment_mode !== paymentMode) {
                    match = false;
                }
                
                return match;
            });
            
            displayPayments();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('filterFromDate').value = '';
            document.getElementById('filterToDate').value = '';
            document.getElementById('filterAmountRange').value = 'all';
            document.getElementById('filterPaymentMode').value = 'all';
            
            filteredPayments = [...payments];
            displayPayments();
        }
        
        // Update summary
        function updateSummary() {
            if (!selectedStudent) return;
            
            const totalFees = selectedStudent.total_fees;
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = Math.max(0, totalFees - totalPaid);
            const progressPercentage = totalFees > 0 ? Math.min(100, Math.round((totalPaid / totalFees) * 100)) : 0;
            
            document.getElementById('summaryTotalFees').textContent = `₹${totalFees}`;
            document.getElementById('summaryPaid').textContent = `₹${totalPaid}`;
            document.getElementById('summaryRemaining').textContent = `₹${remaining}`;
            document.getElementById('summaryInstallments').textContent = payments.length;
            
            document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            document.getElementById('paidAmount').textContent = `₹${totalPaid}`;
            document.getElementById('remainingAmount').textContent = `₹${remaining}`;
            
            // Change progress bar color based on completion
            const progressFill = document.getElementById('progressFill');
            if (progressPercentage >= 100) {
                progressFill.style.background = 'linear-gradient(to right, #2ecc71, #27ae60)';
            } else if (progressPercentage >= 50) {
                progressFill.style.background = 'linear-gradient(to right, #f1c40f, #f39c12)';
            } else {
                progressFill.style.background = 'linear-gradient(to right, #e74c3c, #c0392b)';
            }
        }
        
        // Generate receipt number
        function generateReceiptNumber() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const nextYear = currentYear + 1;
            const random4 = Math.floor(1000 + Math.random() * 9000);
            const receiptNumber = `${currentYear}-${nextYear.toString().slice(-2)}/${random4}`;
            document.getElementById('receiptNumberDisplay').textContent = receiptNumber;
            return receiptNumber;
        }
        
        // Open payment modal
        function openPaymentModal() {
            document.getElementById('paymentModal').classList.add('show');
            generateReceiptNumber();
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            // Clear form if not editing
            if (!editingPaymentId) {
                document.getElementById('paymentForm').reset();
                document.getElementById('receiptNumberDisplay').textContent = generateReceiptNumber();
            }
        }
        
        // Close payment modal
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('show');
            editingPaymentId = null;
            document.getElementById('paymentForm').reset();
        }
        
        // Submit payment
        async function submitPayment() {
            if (!selectedStudent) {
                showNotification('No student selected', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMode = document.getElementById('paymentMode').value;
            const transactionId = document.getElementById('transactionId').value.trim();
            const notes = document.getElementById('paymentNotes').value.trim();
            const receiptNumber = document.getElementById('receiptNumberDisplay').textContent;
            
            if (!amount || amount <= 0) {
                showNotification('Please enter valid amount', 'error');
                return;
            }
            
            if (!paymentDate) {
                showNotification('Please select payment date', 'error');
                return;
            }
            
            if (!paymentMode) {
                showNotification('Please select payment mode', 'error');
                return;
            }
            
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = selectedStudent.total_fees - totalPaid;
            
            if (amount > remaining && !editingPaymentId) {
                showNotification(`Amount exceeds remaining fees (₹${remaining})`, 'error');
                return;
            }
            
            const paymentData = {
                student_id: selectedStudent.id,
                student_name: selectedStudent.student_name,
                roll_number: selectedStudent.roll_number,
                receipt_number: receiptNumber,
                amount: amount,
                payment_date: paymentDate,
                payment_mode: paymentMode,
                transaction_id: transactionId || null,
                notes: notes || null,
                status: 'Paid',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            try {
                if (supabase) {
                    if (editingPaymentId) {
                        // Update existing payment
                        const { data, error } = await supabase
                            .from('payments')
                            .update(paymentData)
                            .eq('id', editingPaymentId)
                            .select();
                        
                        if (error) throw error;
                        
                        // Update local data
                        const index = payments.findIndex(p => p.id === editingPaymentId);
                        if (index !== -1) {
                            payments[index] = { ...payments[index], ...paymentData };
                        }
                        
                        showNotification('Payment updated successfully!', 'success');
                    } else {
                        // Insert new payment
                        const { data, error } = await supabase
                            .from('payments')
                            .insert([paymentData])
                            .select();
                        
                        if (error) throw error;
                        
                        if (data && data.length > 0) {
                            payments.unshift(data[0]);
                        }
                        
                        showNotification(`Payment of ₹${amount} added successfully!`, 'success');
                    }
                } else {
                    // Local storage implementation
                    let allPayments = JSON.parse(localStorage.getItem('payments') || '[]');
                    
                    if (editingPaymentId) {
                        // Update existing payment
                        const index = allPayments.findIndex(p => p.id === editingPaymentId);
                        if (index !== -1) {
                            paymentData.id = editingPaymentId;
                            allPayments[index] = paymentData;
                            // Update local payments array
                            const globalIndex = payments.findIndex(p => p.id === editingPaymentId);
                            if (globalIndex !== -1) {
                                payments[globalIndex] = paymentData;
                            }
                        }
                        showNotification('Payment updated successfully!', 'success');
                    } else {
                        // Add new payment
                        paymentData.id = Date.now();
                        allPayments.push(paymentData);
                        payments.unshift(paymentData);
                        showNotification(`Payment of ₹${amount} added successfully!`, 'success');
                    }
                    
                    localStorage.setItem('payments', JSON.stringify(allPayments));
                }
                
                closePaymentModal();
                filteredPayments = [...payments];
                displayPayments();
                updateSummary();
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error saving payment', 'error');
            }
        }
        
        // Edit payment
        function editPayment(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            editingPaymentId = paymentId;
            
            // Populate form with payment data
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentDate').value = payment.payment_date;
            document.getElementById('paymentMode').value = payment.payment_mode;
            document.getElementById('transactionId').value = payment.transaction_id || '';
            document.getElementById('paymentNotes').value = payment.notes || '';
            document.getElementById('receiptNumberDisplay').textContent = payment.receipt_number || generateReceiptNumber();
            
            openPaymentModal();
            showNotification(`Editing payment: ${payment.receipt_number}`, 'warning');
        }
        
        // Delete payment
        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment?')) {
                return;
            }
            
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            try {
                if (supabase) {
                    const { error } = await supabase
                        .from('payments')
                        .delete()
                        .eq('id', paymentId);
                    
                    if (error) throw error;
                } else {
                    let allPayments = JSON.parse(localStorage.getItem('payments') || '[]');
                    allPayments = allPayments.filter(p => p.id !== paymentId);
                    localStorage.setItem('payments', JSON.stringify(allPayments));
                }
                
                // Remove from local arrays
                payments = payments.filter(p => p.id !== paymentId);
                filteredPayments = filteredPayments.filter(p => p.id !== paymentId);
                
                displayPayments();
                updateSummary();
                
                showNotification('Payment deleted successfully!', 'success');
                
            } catch (error) {
                console.error('Error deleting payment:', error);
                showNotification('Error deleting payment', 'error');
            }
        }
        
        // Open print modal for specific payment
        function openPrintModalForPayment(paymentId) {
            selectedPaymentForPrint = payments.find(p => p.id === paymentId);
            if (!selectedPaymentForPrint) return;
            
            selectPrintOption('receipt');
            openPrintModal();
        }
        
        // Open print modal
        function openPrintModal() {
            document.getElementById('printModal').classList.add('show');
            document.getElementById('printPreview').classList.remove('show');
            document.getElementById('printPreview').innerHTML = '';
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('printNowBtn').disabled = true;
            document.getElementById('downloadPdfBtn').disabled = true;
        }
        
        // Close print modal
        function closePrintModal() {
            document.getElementById('printModal').classList.remove('show');
            selectedPaymentForPrint = null;
        }
        
        // Select print option
        function selectPrintOption(option) {
            selectedPrintOption = option;
            
            // Update UI
            document.getElementById('printReceiptOption').classList.remove('selected');
            document.getElementById('printStatementOption').classList.remove('selected');
            
            document.getElementById(`print${option.charAt(0).toUpperCase() + option.slice(1)}Option`).classList.add('selected');
            
            // Reset preview
            document.getElementById('printPreview').classHTML = '';
            document.getElementById('printPreview').classList.remove('show');
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('printNowBtn').disabled = true;
            document.getElementById('downloadPdfBtn').disabled = true;
        }
        
        // Generate preview
        function generatePreview() {
            const previewElement = document.getElementById('printPreview');
            
            let previewHTML = '';
            
            if (selectedPrintOption === 'receipt') {
                previewHTML = generateReceiptHTML(selectedPaymentForPrint);
            } else {
                previewHTML = generateStatementHTML();
            }
            
            previewElement.innerHTML = previewHTML;
            previewElement.classList.add('show');
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('printNowBtn').disabled = false;
            document.getElementById('downloadPdfBtn').disabled = false;
            
            showNotification('Preview generated successfully!', 'success');
        }
        
        // Generate receipt HTML for 2 per page
      
     
function generateReceiptHTML(payment = null) {
    const printPayment = payment || (payments.length > 0 ? payments[0] : null);
    if (!printPayment) return '<div class="no-payments">No payment to print</div>';
    
    const paymentDate = new Date(printPayment.payment_date);
    const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
    const remaining = selectedStudent.total_fees - totalPaid;
    const paymentStatus = remaining <= 0 ? 'FULLY PAID' : 'PARTIAL PAYMENT';
    const statusColor = remaining <= 0 ? '#27ae60' : '#f39c12';
    
    const receiptHTML = `
        <div class="receipt-print" style="font-family: Arial, sans-serif; font-size: 12px; padding: 20px; margin: 0; border: 1px solid #ddd; border-radius: 5px; background: white; width: 100%; height: 400px; position: relative;">
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #2c3e50; font-size: 18px;">FEE PAYMENT RECEIPT</h2>
                <p style="color: #7f8c8d; margin: 5px 0; font-size: 12px;">Official Payment Acknowledgement</p>
                <p style="margin: 3px 0; font-size: 11px;">Receipt No: ${printPayment.receipt_number}</p>
                <div style="background: ${statusColor}; color: white; padding: 3px 15px; border-radius: 15px; display: inline-block; margin-top: 5px; font-size: 11px; font-weight: bold;">
                    ${paymentStatus}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 12px;">
                <div>
                    <h4 style="color: #2c3e50; border-bottom: 1px solid #2c3e50; padding-bottom: 5px; margin-bottom: 10px; font-size: 14px;">STUDENT INFO</h4>
                    <p><strong>Name:</strong> ${selectedStudent.student_name}</p>
                    <p><strong>Roll No:</strong> ${selectedStudent.roll_number}</p>
                    <p><strong>Course:</strong> ${selectedStudent.course}</p>
                    <p><strong>Date:</strong> ${paymentDate.toLocaleDateString('en-IN')}</p>
                </div>
                
                <div>
                    <h4 style="color: #2c3e50; border-bottom: 1px solid #2c3e50; padding-bottom: 5px; margin-bottom: 10px; font-size: 14px;">PAYMENT INFO</h4>
                    <p><strong>Amount:</strong> <span style="font-weight: bold; color: #27ae60; font-size: 14px;">₹${printPayment.amount}</span></p>
                    <p><strong>Mode:</strong> ${printPayment.payment_mode}</p>
                    <p><strong>Transaction ID:</strong> ${printPayment.transaction_id || 'N/A'}</p>
                    <p><strong>Status:</strong> <span style="color: #27ae60; font-weight: bold;">PAID</span></p>
                </div>
            </div><br><br><br>
            
          
            <div style="position: absolute; bottom: 20px; width: 100%;">
               <div style="display: flex; justify-content: flex-end; margin-top: 30px; font-size: 11px;">
    <div style="text-align: center; width: 150px;">
        <div style="border-top: 1px solid #000; width: 150px; margin: 10px auto 5px;"></div>
        <div>Authorized Signatory</div>
    </div>
</div>

                
                <div style="text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd; color: #7f8c8d; font-size: 10px;">
                    <p>Computer generated receipt | Generated: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
            </div>
        </div>
    `;
    
    // Return 2 copies for 2 per page printing
    return receiptHTML 
    //+ receiptHTML;
}


/// Generate statement HTML showing all payments
function generateStatementHTML() {
    if (!selectedStudent || payments.length === 0) {
        return '<div class="no-payments">No payment data available</div>';
    }
    
    const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
    const remaining = Math.max(0, selectedStudent.total_fees - totalPaid);
    const paymentStatus = remaining <= 0 ? 'FULLY PAID' : 'PARTIAL PAYMENT';
    const statusColor = remaining <= 0 ? '#27ae60' : '#f39c12';
    
    // Format current date
    const today = new Date();
    const formattedDate = today.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
    
    const statementHTML = `
        <div class="receipt-print" style="font-family: Arial, sans-serif; font-size: 12px; padding: 20px; margin: 0; border: 1px solid #ddd; border-radius: 5px; background: white; width: 100%; height: 650px; position: relative;">
            <!-- Header Section -->
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #2c3e50; font-size: 18px;">FEE PAYMENT STATEMENT</h2>
                <p style="color: #7f8c8d; margin: 5px 0; font-size: 12px;">Complete Payment History</p>
                <p style="margin: 3px 0; font-size: 11px;">Statement No: STMT-${selectedStudent.roll_number}-${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2, '0')}</p>
                <div style="background: ${statusColor}; color: white; padding: 3px 15px; border-radius: 15px; display: inline-block; margin-top: 5px; font-size: 11px; font-weight: bold;">
                    ${paymentStatus}
                </div>
            </div>
            
            <!-- Two Column Layout: Student Info on Left, Fee Summary on Right -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 12px;">
                <!-- Left Column: Student Information -->
                <div>
                    <h4 style="color: #2c3e50; border-bottom: 1px solid #2c3e50; padding-bottom: 5px; margin-bottom: 10px; font-size: 14px;">STUDENT INFORMATION</h4>
                    <p><strong>Name:</strong> ${selectedStudent.student_name}</p>
                    <p><strong>Roll No:</strong> ${selectedStudent.roll_number}</p>
                    <p><strong>Course:</strong> ${selectedStudent.course || 'N/A'}</p>
                    <p><strong>Statement Date:</strong> ${formattedDate}</p>
                </div>
                
                <!-- Right Column: Fee Summary -->
                <div>
                    <h4 style="color: #2c3e50; border-bottom: 1px solid #2c3e50; padding-bottom: 5px; margin-bottom: 10px; font-size: 14px;">FEE SUMMARY</h4>
                    <p><strong>Total Fees:</strong> <span style="color: #2c3e50; font-weight: bold;">₹${selectedStudent.total_fees.toLocaleString('en-IN')}</span></p>
                    <p><strong>Total Paid:</strong> <span style="color: #27ae60; font-weight: bold;">₹${totalPaid.toLocaleString('en-IN')}</span></p>
                    <p><strong>Remaining:</strong> <span style="color: ${remaining > 0 ? '#e74c3c' : '#27ae60'}; font-weight: bold;">₹${remaining.toLocaleString('en-IN')}</span></p>
                    <p><strong>Payment Count:</strong> ${payments.length} Installment(s)</p>
                </div>
            </div>
            
            <!-- Payments Table - Below the two columns -->
            <div style="margin-top: 20px;">
                <h4 style="color: #2c3e50; border-bottom: 1px solid #2c3e50; padding-bottom: 5px; margin-bottom: 10px; font-size: 14px;">PAYMENT HISTORY</h4>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 11px; border: 1px solid #ddd; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 8px; text-align: center; border-right: 1px solid #eee;">#</th>
                            <th style="padding: 8px; text-align: left; border-right: 1px solid #eee;">Receipt No</th>
                            <th style="padding: 8px; text-align: left; border-right: 1px solid #eee;">Date</th>
                            <th style="padding: 8px; text-align: right; border-right: 1px solid #eee;">Amount</th>
                            <th style="padding: 8px; text-align: left; border-right: 1px solid #eee;">Mode</th>
                            <th style="padding: 8px; text-align: left;">Transaction ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(() => {
                            let html = '';
                            let runningTotal = 0;
                            const sortedPayments = [...payments].sort((a, b) => 
                                new Date(a.payment_date) - new Date(b.payment_date)
                            );
                            
                            sortedPayments.forEach((payment, index) => {
                                const paymentDate = new Date(payment.payment_date);
                                runningTotal += payment.amount;
                                
                                html += `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; text-align: center; border-right: 1px solid #eee;">${index + 1}</td>
                                        <td style="padding: 8px; border-right: 1px solid #eee;">${payment.receipt_number || 'N/A'}</td>
                                        <td style="padding: 8px; border-right: 1px solid #eee;">${paymentDate.toLocaleDateString('en-IN')}</td>
                                        <td style="padding: 8px; text-align: right; border-right: 1px solid #eee;">₹${payment.amount.toLocaleString('en-IN')}</td>
                                        <td style="padding: 8px; border-right: 1px solid #eee;">${payment.payment_mode}</td>
                                        <td style="padding: 8px;">${payment.transaction_id || 'N/A'}</td>
                                    </tr>
                                `;
                            });
                            return html;
                        })()}
                    </tbody>
                </table>
            </div>
            
           
            <div style="position: absolute; bottom: 0px; right: 5px; width: 100%;">
                <!-- Signature on right side -->
                <div style="display: flex; justify-content: flex-end; margin-top: 20px; font-size: 11px;">
                    <div style="text-align: center; width: 150px;">
                        <div style="border-top: 1px solid #000; width: 150px; margin: 5px auto 5px;"></div>
                        <div>Authorized Signatory</div>
                    </div>
                </div>
      
                <div style="text-align: center; margin-top: -10px;border-top: 1px dashed #ddd; color: #7f8c8d; font-size: 10px;">
                    <p>Computer generated statement | ${payments.length} payment(s) | Generated: ${new Date().toLocaleDateString('en-IN')}</p>
                </div>
            </div>
        </div>
    `;
    
    return statementHTML;
}


function printNow() {
    const printContent = document.getElementById('printPreview').innerHTML;
    const printWindow = window.open('', '_blank', 'width=900,height=650');
    
    if (!printWindow) {
        showNotification('Please allow popups for printing', 'error');
        return;
    }
    
    printWindow.document.write('<html><head><title>Print</title>');
    printWindow.document.write('<meta charset="UTF-8">');
    printWindow.document.write('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
    printWindow.document.write('<style>');
    printWindow.document.write('@media print {');
    printWindow.document.write('  @page { size: A4; margin: 5mm; }');
    printWindow.document.write('  body { margin: 0; padding: 0; }');
    printWindow.document.write('  .no-print { display: none !important; }');
    printWindow.document.write('  .receipt-print { width: 100% !important; float: left !important; page-break-inside: avoid !important; margin: 5mm 0 !important; padding: 15px !important; box-sizing: border-box !important; height: 500px !important; }');
    printWindow.document.write('  .page-break { page-break-after: always !important; clear: both !important; }');
    printWindow.document.write('}');
    printWindow.document.write('@media screen {');
    printWindow.document.write('  .receipt-print { width: 100% !important; margin: 10px 0 !important; padding: 20px !important; height: 400px !important; }');
    printWindow.document.write('}');
    printWindow.document.write('</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(printContent);
    printWindow.document.write('<button class="no-print" style="position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;" onclick="window.print()">Print Now</button>');
    printWindow.document.write('<script>setTimeout(function() { window.print(); }, 500);<\/script>');
    printWindow.document.write('</body></html>');
    
    printWindow.document.close();
    printWindow.focus();
}
        
        // Download PDF
        async function downloadPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const previewElement = document.getElementById('printPreview');
                
                const canvas = await html2canvas(previewElement, {
                    scale: 1.5,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                const imgWidth = pageWidth - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                let fileName = '';
                if (selectedPrintOption === 'receipt') {
                    const payment = selectedPaymentForPrint || payments[0];
                    fileName = `Receipt_${payment?.receipt_number || 'unknown'}.pdf`;
                } else {
                    fileName = `Statement_${selectedStudent.roll_number}_${Date.now()}.pdf`;
                }
                
                doc.save(fileName);
                showNotification('PDF downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('Error generating PDF', 'error');
            }
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>



